# Travel-GPT 项目需求文档

> **文档版本**: v1.4  
> **最后更新**: 2026-01-13  
> **项目状态**: 持续开发中

## 📋 目录

1. [项目概述](#项目概述)
2. [核心功能需求](#核心功能需求)
3. [用户认证系统](#用户认证系统)
4. [AI行程规划功能](#ai行程规划功能)
5. [数据管理功能](#数据管理功能)
6. [前端功能需求](#前端功能需求)
7. [后端功能需求](#后端功能需求)
8. [配置与集成](#配置与集成)
9. [未实现功能（待开发）](#未实现功能待开发)
10. [技术债务与改进](#技术债务与改进)

---

## 项目概述

Travel-GPT 是一个基于 AI 的智能旅行规划助手，帮助用户生成个性化的周末旅行行程。项目采用前后端分离架构，支持游客模式和注册用户模式。

### 核心价值
- 🤖 **AI 智能规划**：使用 LLM 生成个性化旅行行程
- 👤 **用户系统**：完整的注册登录流程，支持历史记录管理
- 🖼️ **真实图片**：集成图片 API 展示景点真实照片
- 📱 **响应式设计**：完美适配桌面端和移动端
- 🔒 **数据持久化**：SQLite 数据库存储用户信息和历史行程
- 🎯 **游客模式**：无需注册即可使用核心功能

---

## 核心功能需求

### 1. 旅行行程生成功能 ✅ 已实现

#### 1.1 行程规划输入
- ✅ **目的地输入**：支持城市名称输入（必填）
- ✅ **天数选择**：1-5天可选（默认2天）
- ✅ **预算设置**：支持预算范围输入（可选）
- ✅ **出行人数**：支持人数设置（默认2人）
- ✅ **偏好标签**：多选标签系统
  - ✅ 美食 (food)
  - ✅ 户外 (outdoor)
  - ✅ 购物 (shopping)
  - ✅ 文化 (culture)
  - ✅ 放松 (relax)
  - ✅ 冒险 (adventure)
  - ✅ 亲子 (family)
- ✅ **额外要求**：文本输入框，支持自由描述
- ✅ **行程名称**：可自定义行程名称（可选）

#### 1.2 预设示例
- ✅ **快速开始卡片**：提供3个预设示例
  - ✅ 上海2天美食之旅
  - ✅ 成都周末户外放松
  - ✅ 京都3天文化体验
- ✅ **一键填充**：点击预设卡片自动填充表单

#### 1.3 行程生成流程
- ✅ **实时日志显示**：显示 AI 规划过程（前端模拟步骤，后端实际生成）
- ✅ **进度指示**：显示生成进度百分比
- ✅ **暂停/继续**：前端UI支持暂停/继续按钮（仅前端UI，后端实际为一次性生成）
- ✅ **停止功能**：支持停止生成并返回首页
- ✅ **最终归纳阶段**：显示最终归纳总结的动画提示
- ✅ **错误处理**：友好的错误提示
- ✅ **唯一URL生成**：游客用户生成行程后自动创建临时分享链接，跳转到唯一URL（`/result?token=xxx`），避免并发冲突

#### 1.4 生成的行程内容
- ✅ **预算概览**
  - ✅ 总预算金额
  - ✅ 预算分类明细（交通、住宿、餐饮、景点、杂费）
  - ✅ 预算饼图可视化
- ✅ **每日详细行程**
  - ✅ 每日标题
  - ✅ 活动列表（时间、标题、描述、时长、费用、地址、推荐理由）
  - ✅ 活动图片（通过 Unsplash/Pexels API 自动获取）
- ✅ **隐藏宝石推荐**
  - ✅ 2-3个小众地点推荐
  - ✅ 包含标题、描述、类别
- ✅ **实用旅行建议**
  - ✅ 交通建议
  - ✅ 打包清单
  - ✅ 天气信息
  - ✅ 季节注意事项

---

## 用户认证系统

### 2.1 注册功能 ✅ 已实现

#### 2.1.1 邮箱验证注册
- ✅ **邮箱输入**：支持邮箱格式验证
- ✅ **验证码发送**：发送6位数字验证码到邮箱
- ✅ **验证码倒计时**：60秒倒计时，防止频繁发送
- ✅ **验证码验证**：验证码有效期5分钟
- ✅ **密码设置**：至少6位密码
- ✅ **密码确认**：两次密码输入一致性验证
- ✅ **密码显示/隐藏**：支持密码可见性切换
- ✅ **自动登录**：注册成功后自动登录

#### 2.1.2 注册流程
1. ✅ 输入邮箱 → 发送验证码
2. ✅ 输入验证码 → 验证验证码
3. ✅ 输入密码和确认密码 → 提交注册
4. ✅ 注册成功 → 自动登录并跳转首页

### 2.2 登录功能 ✅ 已实现

#### 2.2.1 邮箱密码登录
- ✅ **邮箱输入**：支持邮箱格式验证
- ✅ **密码输入**：支持密码显示/隐藏
- ✅ **记住登录状态**：使用 JWT Token，有效期7天
- ✅ **自动跳转**：登录成功后跳转首页

#### 2.2.2 游客模式
- ✅ **跳过登录**：首页和登录页提供"跳过登录，直接使用"链接
- ✅ **无限制使用**：游客可以正常使用行程生成功能
- ✅ **历史记录限制**：游客生成的行程不保存到数据库
- ✅ **唯一URL**：游客用户生成行程后自动创建临时分享链接，获得唯一URL（`/result?token=xxx`）
- ✅ **并发安全**：每个游客都有独立的分享token，避免多用户在同一浏览器上的数据冲突

### 2.3 忘记密码功能 ✅ 已实现

#### 2.3.1 密码重置流程
- ✅ **邮箱验证**：输入注册邮箱
- ✅ **验证码发送**：发送重置密码验证码
- ✅ **验证码验证**：验证码有效期5分钟
- ✅ **新密码设置**：至少6位新密码
- ✅ **自动登录**：重置成功后自动登录

#### 2.3.2 忘记密码页面
- ✅ **分步表单**：先发送验证码，再输入新密码
- ✅ **密码显示/隐藏**：支持密码可见性切换
- ✅ **返回登录**：提供返回登录页链接

### 2.4 用户信息管理 ✅ 部分实现

#### 2.4.1 已实现
- ✅ **获取当前用户信息**：`GET /api/auth/me`
- ✅ **用户邮箱显示**：首页和历史页面显示用户邮箱
- ✅ **密码修改**：`PUT /api/auth/me/password` - 登录状态下修改密码（需要验证旧密码）
- ✅ **账号注销**：`DELETE /api/auth/me` - 删除账号及关联数据

#### 2.4.2 未实现
- ⚠️ **用户资料编辑**：修改邮箱、昵称等功能
- ⚠️ **头像上传**：用户头像设置功能

---

## AI行程规划功能

### 3.1 LLM 配置 ✅ 已实现

#### 3.1.1 支持的 LLM 提供商
- ✅ **NVIDIA GLM API**（默认/推荐）
  - ✅ 配置项：`LLM_PROVIDER=nvidia`
  - ✅ API Key：`NVIDIA_API_KEY`
  - ✅ 模型：`NVIDIA_MODEL`（默认：z-ai/glm4.7）
- ✅ **本地 Ollama**（免费）
  - ✅ 配置项：`LLM_PROVIDER=ollama`
  - ✅ 服务地址：`OLLAMA_BASE_URL`（默认：http://localhost:11434）
  - ✅ 模型：`OLLAMA_MODEL`（默认：qwen3:8b）
- ✅ **阿里云 DashScope**（兼容）
  - ✅ 配置项：`LLM_PROVIDER=dashscope`
  - ✅ API Key：`DASHSCOPE_API_KEY`
  - ✅ 模型：qwen-plus（固定）

#### 3.1.2 配置兼容性
- ✅ **新配置方式**：使用 `LLM_PROVIDER` 选择提供商
- ✅ **旧配置方式**：兼容 `LLM_API_KEY`、`LLM_OPENAI_BASE`、`LLM_MODEL_NAME`
- ✅ **配置优先级**：旧配置优先，未设置则使用新配置

### 3.2 AI Agent 工具 ✅ 已实现

#### 3.2.1 已集成的工具
- ✅ **景点搜索工具**：`search_attractions(city)`（当前为模拟数据）
- ✅ **餐厅搜索工具**：`search_restaurants(query)`（当前为模拟数据）
- ✅ **图片获取工具**：`get_place_images(place_name)`（当前为模拟数据）
- ✅ **天气信息工具**：`get_weather_info(city)`（集成 OpenWeatherMap API，可选）

#### 3.2.2 可选增强工具
- ✅ **Tavily 搜索工具**：增强搜索功能（需要 `TAVILY_API_KEY`）
  - ✅ 已集成但需要 API Key 才启用
  - ✅ 用于搜索景点、餐厅等实时信息

### 3.3 图片搜索功能 ✅ 已实现

#### 3.3.1 图片 API 集成
- ✅ **Unsplash API**（推荐）
  - ✅ 配置项：`UNSPLASH_ACCESS_KEY`
  - ✅ 免费限额：50 requests/hour
  - ✅ 图片质量：高质量专业旅行照片
- ✅ **Pexels API**（备用）
  - ✅ 配置项：`PEXELS_API_KEY`
  - ✅ 免费限额：200 requests/hour, 20,000/month
  - ✅ 完全免费无限制

#### 3.3.2 图片搜索逻辑
- ✅ **智能关键词提取**：从活动名称中提取搜索关键词
- ✅ **分类识别**：自动识别美食、景点、酒店等类别
- ✅ **多查询策略**：从具体到通用的搜索策略
- ✅ **降级处理**：Unsplash 失败自动使用 Pexels
- ✅ **图片过滤**：前端只显示允许的图片域名（Unsplash/Pexels）

### 3.4 行程生成优化 ✅ 已实现

#### 3.4.1 Prompt 工程
- ✅ **详细 Prompt**：包含用户所有需求信息
- ✅ **格式要求**：严格的 JSON 输出格式
- ✅ **地址格式要求**：必须包含"区+街道+门牌号"
- ✅ **活动名称要求**：使用具体明确的名称
- ✅ **图片字段禁止**：明确禁止 LLM 生成 images 字段

#### 3.4.2 后处理
- ✅ **图片自动添加**：后端自动为每个活动添加图片
- ✅ **数据验证**：验证生成的 JSON 格式
- ✅ **错误处理**：友好的错误提示

---

## 数据管理功能

### 4.1 历史记录管理 ✅ 已实现

#### 4.1.1 历史记录列表
- ✅ **获取历史记录**：`GET /api/history`
  - ✅ 支持分页：`limit`、`offset` 参数
  - ✅ 按创建时间倒序排列
  - ✅ 只返回当前用户的历史记录
- ✅ **历史记录显示**
  - ✅ 目的地、天数、预算
  - ✅ 创建时间
  - ✅ 行程预览信息（agentName、travelers、totalBudget）

#### 4.1.2 历史记录详情
- ✅ **查看详情**：`GET /api/history/{itinerary_id}`
  - ✅ 返回完整的行程数据
  - ✅ 权限验证：只能查看自己的记录
- ✅ **详情页面跳转**：从历史记录跳转到结果页面

#### 4.1.3 历史记录删除
- ✅ **删除记录**：`DELETE /api/history/{itinerary_id}`
  - ✅ 权限验证：只能删除自己的记录
  - ✅ 确认对话框：删除前确认

#### 4.1.4 历史记录保存
- ✅ **自动保存**：登录用户生成的行程自动保存
- ✅ **游客模式**：未登录用户不保存历史记录
- ✅ **保存内容**：完整的行程数据、请求参数、生成时间

#### 4.1.5 历史记录搜索与筛选 ✅ 已实现
- ✅ **后端API支持**：
  - ✅ **关键词搜索**：按目的地、行程名称搜索（`search` 参数）
  - ✅ **筛选功能**：按天数范围（`min_days`、`max_days`）、预算范围（`min_budget`、`max_budget`）筛选
  - ✅ **排序功能**：按创建时间、预算、天数排序（`sort_by`、`sort_order` 参数）
  - ✅ **收藏状态显示**：历史记录列表中返回收藏标记（`is_favorited` 字段）
  - ✅ **收藏优先排序**：收藏的行程优先显示在列表前面
- ✅ **前端UI**：
  - ✅ **搜索框**：实时搜索目的地或行程名称
  - ✅ **筛选面板**：支持按天数范围、预算范围筛选，可展开/收起
  - ✅ **排序功能**：下拉选择排序字段（创建时间/预算/天数），支持升序/降序切换
  - ✅ **清除筛选**：一键清除所有筛选条件
  - ✅ **实时更新**：搜索、筛选、排序参数变化时自动重新加载数据

### 4.2 数据导出功能 ✅ 已实现

#### 4.2.1 PDF 导出
- ✅ **PDF 生成**：`GET /api/itinerary/{id}/export/pdf` - 使用 reportlab 生成 PDF 文件
- ✅ **PDF 模板**：美观的 PDF 模板设计，包含预算概览、每日行程、隐藏宝石、实用建议
- ✅ **包含内容**：完整行程数据、预算图表、详细活动信息
- ✅ **前端下载**：结果页面提供下载按钮

### 4.3 分享功能 ✅ 已实现

#### 4.3.1 分享链接生成
- ✅ **分享 Token**：生成唯一的分享 Token（64位随机字符串）
- ✅ **分享记录表**：`ShareLink` 数据模型（id、itinerary_id、share_token、is_public、expires_at、created_at）
- ✅ **临时分享表**：`TemporaryShare` 数据模型（id、share_token、itinerary_data、expires_at、created_at）
- ✅ **分享 API**：
  - ✅ `POST /api/itinerary/{id}/share` - 创建或更新分享链接（登录用户）
  - ✅ `POST /api/share/temporary` - 创建临时分享链接（游客用户）
  - ✅ `GET /api/share/{token}` - 获取分享的行程详情（支持永久分享和临时分享，无需登录）
- ✅ **访问控制**：支持公开/私密分享（`is_public` 参数）
- ✅ **链接有效期**：支持设置链接有效期（`expires_days` 参数，None 表示永久有效）
- ✅ **游客用户支持**：游客用户生成行程后自动创建临时分享链接，获得唯一URL

#### 4.3.2 分享方式
- ✅ **复制链接**：一键复制分享链接到剪贴板
- ✅ **唯一URL**：每个游客用户都有唯一的分享URL（`/result?token=xxx`），避免并发冲突
- ⚠️ **社交媒体分享**：分享到微信、微博等（未实现）
- ⚠️ **二维码生成**：生成分享二维码（未实现）

#### 4.3.3 分享页面
- ✅ **公开分享页**：`/share/{token}` 页面（无需登录即可查看）
- ✅ **结果页支持token**：`/result?token={token}` 页面支持通过token加载分享的行程
- ✅ **只读模式**：分享页面为只读模式，不可编辑
- ✅ **数据隔离**：通过API获取数据，不依赖localStorage，避免多用户冲突

### 4.4 收藏功能 ✅ 已实现

#### 4.4.1 收藏功能
- ✅ **收藏数据模型**：`Favorite` 表（id、user_id、itinerary_id、created_at）
- ✅ **收藏 API**：
  - ✅ `POST /api/favorites/{itinerary_id}` - 添加收藏
  - ✅ `DELETE /api/favorites/{itinerary_id}` - 取消收藏
  - ✅ `GET /api/favorites/{itinerary_id}/status` - 检查收藏状态
  - ✅ `GET /api/favorites` - 获取所有收藏的行程
- ✅ **收藏显示**：历史记录和行程详情页面显示收藏状态
- ✅ **收藏优先**：历史记录列表中收藏的行程优先显示

### 4.5 行程编辑功能 ✅ 已实现

#### 4.5.1 行程修改
- ✅ **编辑行程**：`PUT /api/itinerary/{id}` - 修改行程基本信息（目的地、天数、预算、偏好等）
- ✅ **编辑页面**：结果页面提供编辑对话框，支持修改行程参数

#### 4.5.2 行程优化
- ✅ **重新生成**：`POST /api/itinerary/{id}/regenerate` - 基于现有行程重新生成完整内容
- ⚠️ **部分优化**：只优化特定天的行程（未实现）

---

## 前端功能需求

### 5.1 页面结构 ✅ 已实现

#### 5.1.1 已实现的页面
- ✅ **首页** (`/`)：旅行参数输入表单
- ✅ **登录页** (`/login`)：用户登录
- ✅ **注册页** (`/register`)：用户注册（带验证码）
- ✅ **忘记密码页** (`/forgot-password`)：密码重置
- ✅ **规划页** (`/plan`)：AI 规划过程展示
- ✅ **结果页** (`/result`)：行程结果展示（支持编辑、收藏、分享、PDF导出、重新生成）
  - ✅ 支持通过 `?id={id}` 参数加载登录用户的行程
  - ✅ 支持通过 `?token={token}` 参数加载分享的行程（游客用户或分享链接）
  - ✅ 向后兼容：无参数时从localStorage读取
- ✅ **历史记录页** (`/history`)：历史行程列表（支持查看、删除、收藏状态显示、搜索、筛选、排序）

#### 5.1.2 未实现的页面
- ⚠️ **用户设置页** (`/settings`)：用户资料编辑、密码修改（功能已实现，但无独立页面）
- ⚠️ **行程详情页** (`/itinerary/{id}`)：独立的行程详情页面（当前使用 `/result?id={id}`）

#### 5.1.3 已实现的页面（新增）
- ✅ **分享页** (`/share/{token}`)：公开分享的行程页面（无需登录）

### 5.2 UI/UX 功能 ✅ 已实现

#### 5.2.1 已实现
- ✅ **响应式设计**：适配桌面端和移动端
- ✅ **移动端优先设计**：针对手机竖屏优化的 UI/UX 设计
- ✅ **暗黑模式支持**：Tailwind CSS 暗黑模式
- ✅ **渐变背景**：美观的渐变背景设计
- ✅ **卡片式布局**：使用 shadcn/ui Card 组件
- ✅ **加载状态**：Loader2 动画组件
- ✅ **错误提示**：友好的错误信息显示
- ✅ **成功提示**：操作成功的反馈
- ✅ **横向滚动优化**：移动端快速开始卡片使用横向滚动，避免占用过多垂直空间

#### 5.2.2 数据可视化
- ✅ **预算饼图**：使用 Recharts 显示预算分配
- ✅ **时间轴展示**：每日行程的时间轴展示
- ✅ **图片画廊**：活动图片的轮播展示

### 5.3 导航与路由 ✅ 已实现

#### 5.3.1 导航功能
- ✅ **用户菜单**：显示用户邮箱、历史记录、退出按钮
- ✅ **登录/注册按钮**：未登录时显示
- ✅ **返回按钮**：
  - ✅ 历史记录页返回首页
  - ✅ 行程详情页智能返回（从历史记录跳转的返回历史记录页，从首页生成的返回首页）

#### 5.3.2 路由保护
- ✅ **历史记录保护**：未登录用户跳转到登录页
- ✅ **游客模式支持**：首页和规划功能无需登录

### 5.4 状态管理 ✅ 已实现

#### 5.4.1 认证状态
- ✅ **AuthContext**：使用 React Context 管理认证状态
- ✅ **Token 存储**：localStorage 存储 JWT Token
- ✅ **自动验证**：页面加载时自动验证 Token
- ✅ **状态持久化**：刷新页面保持登录状态

#### 5.4.2 数据状态
- ✅ **表单数据**：localStorage 临时存储表单数据
- ✅ **行程数据**：localStorage 临时存储生成的行程（向后兼容）
- ✅ **API优先**：结果页面优先从API获取数据（通过token或id），避免localStorage冲突
- ✅ **唯一标识**：游客用户通过token参数访问，登录用户通过id参数访问

---

## 后端功能需求

### 6.1 API 端点 ✅ 已实现

#### 6.1.1 认证相关 API
- ✅ `POST /api/auth/send-verification-code` - 发送注册验证码
- ✅ `POST /api/auth/verify-code` - 验证注册验证码
- ✅ `POST /api/auth/register` - 用户注册
- ✅ `POST /api/auth/login` - 用户登录
- ✅ `GET /api/auth/me` - 获取当前用户信息
- ✅ `POST /api/auth/send-reset-password-code` - 发送重置密码验证码
- ✅ `POST /api/auth/verify-reset-password-code` - 验证重置密码验证码
- ✅ `POST /api/auth/reset-password` - 重置密码

#### 6.1.2 行程相关 API
- ✅ `POST /api/generate-plan` - 生成旅行行程
  - ✅ 支持登录和未登录用户
  - ✅ 登录用户自动保存历史记录

#### 6.1.3 历史记录 API
- ✅ `GET /api/history` - 获取历史记录列表
  - ✅ 支持分页（`limit`、`offset` 参数）
  - ✅ 支持搜索（`search` 参数，按目的地、行程名称）
  - ✅ 支持筛选（`min_days`、`max_days`、`min_budget`、`max_budget` 参数）
  - ✅ 支持排序（`sort_by`、`sort_order` 参数）
  - ✅ 返回收藏状态（`is_favorited` 字段）
  - ✅ 收藏优先排序
- ✅ `GET /api/history/{itinerary_id}` - 获取历史记录详情
- ✅ `DELETE /api/history/{itinerary_id}` - 删除历史记录

#### 6.1.4 用户管理 API
- ✅ `PUT /api/auth/me/password` - 修改当前用户密码
- ✅ `DELETE /api/auth/me` - 删除当前用户账号

#### 6.1.5 分享 API
- ✅ `POST /api/itinerary/{itinerary_id}/share` - 创建或更新分享链接（登录用户）
- ✅ `POST /api/share/temporary` - 创建临时分享链接（游客用户）
- ✅ `GET /api/share/{share_token}` - 获取分享的行程详情（支持永久分享和临时分享，无需登录）

#### 6.1.6 收藏 API
- ✅ `POST /api/favorites/{itinerary_id}` - 添加收藏
- ✅ `DELETE /api/favorites/{itinerary_id}` - 取消收藏
- ✅ `GET /api/favorites/{itinerary_id}/status` - 检查收藏状态
- ✅ `GET /api/favorites` - 获取所有收藏的行程

#### 6.1.7 行程编辑 API
- ✅ `PUT /api/itinerary/{itinerary_id}` - 更新行程基本信息
- ✅ `POST /api/itinerary/{itinerary_id}/regenerate` - 重新生成行程
- ✅ `GET /api/itinerary/{itinerary_id}/export/pdf` - 导出行程为 PDF

#### 6.1.8 系统 API（原 6.1.4）

#### 6.1.8 系统 API
- ✅ `GET /` - 根路径，返回 API 信息
- ✅ `GET /api/test` - 测试端点
- ✅ `GET /api/health` - 健康检查
- ✅ `GET /test-cors` - CORS 测试

### 6.2 数据库模型 ✅ 已实现

#### 6.2.1 用户表 (User)
- ✅ `id` - 主键
- ✅ `email` - 邮箱（唯一索引）
- ✅ `hashed_password` - 密码哈希
- ✅ `created_at` - 创建时间
- ✅ `updated_at` - 更新时间
- ✅ `itineraries` - 关联的历史记录（一对多）

#### 6.2.2 行程表 (Itinerary)
- ✅ `id` - 主键
- ✅ `user_id` - 用户ID（外键）
- ✅ `agent_name` - 行程名称
- ✅ `destination` - 目的地
- ✅ `days` - 天数
- ✅ `budget` - 预算
- ✅ `travelers` - 出行人数
- ✅ `preferences` - 偏好（JSON字符串）
- ✅ `extra_requirements` - 额外要求
- ✅ `itinerary_data` - 完整行程数据（JSON字符串）
- ✅ `total_budget` - 总预算（快速检索）
- ✅ `created_at` - 创建时间
- ✅ `updated_at` - 更新时间

#### 6.2.3 邮箱验证码表 (EmailVerification)
- ✅ `id` - 主键
- ✅ `email` - 邮箱（索引）
- ✅ `verification_code` - 验证码
- ✅ `expires_at` - 过期时间
- ✅ `created_at` - 创建时间

#### 6.2.4 分享链接表 (ShareLink)
- ✅ `id` - 主键
- ✅ `itinerary_id` - 行程ID（外键，索引）
- ✅ `share_token` - 分享Token（唯一索引）
- ✅ `is_public` - 是否公开（1=公开, 0=私密）
- ✅ `expires_at` - 过期时间（None 表示永久有效）
- ✅ `created_at` - 创建时间

#### 6.2.5 收藏表 (Favorite)
- ✅ `id` - 主键
- ✅ `user_id` - 用户ID（外键，索引）
- ✅ `itinerary_id` - 行程ID（外键，索引）
- ✅ `created_at` - 创建时间
- ✅ 唯一约束：`(user_id, itinerary_id)` 防止重复收藏

#### 6.2.6 临时分享表 (TemporaryShare)
- ✅ `id` - 主键
- ✅ `share_token` - 分享Token（唯一索引）
- ✅ `itinerary_data` - 完整行程数据（JSON字符串）
- ✅ `expires_at` - 过期时间（必须设置）
- ✅ `created_at` - 创建时间

### 6.3 安全功能 ✅ 已实现

#### 6.3.1 密码安全
- ✅ **密码哈希**：使用 bcrypt 加密存储
- ✅ **密码验证**：安全的密码验证机制
- ✅ **密码强度**：前端验证至少6位

#### 6.3.2 JWT 认证
- ✅ **Token 生成**：使用 python-jose 生成 JWT
- ✅ **Token 验证**：自动验证 Token 有效性
- ✅ **Token 过期**：7天有效期
- ✅ **可选认证**：支持游客模式（`get_current_user_optional`）

#### 6.3.3 验证码安全
- ✅ **验证码生成**：6位随机字母数字组合
- ✅ **验证码过期**：5分钟有效期
- ✅ **一次性使用**：验证成功后自动删除
- ✅ **防重复发送**：60秒倒计时

### 6.4 邮件服务 ✅ 已实现

#### 6.4.1 邮件发送
- ✅ **Resend API**：优先使用 Resend API（推荐）
- ✅ **SMTP 备用**：支持 SMTP 方式发送
- ✅ **SSL/TLS 支持**：支持 465 (SSL) 和 587 (TLS) 端口

#### 6.4.2 邮件模板
- ✅ **注册验证码邮件**：美观的 HTML 邮件模板
- ✅ **重置密码邮件**：专业的密码重置邮件模板

### 6.5 错误处理 ✅ 已实现

#### 6.5.1 错误响应
- ✅ **统一错误格式**：`{"detail": "错误信息"}`
- ✅ **HTTP 状态码**：正确的状态码返回
- ✅ **验证错误**：详细的参数验证错误信息

#### 6.5.2 日志记录
- ✅ **日志配置**：使用 Python logging 模块
- ✅ **日志级别**：INFO 级别日志
- ✅ **请求日志**：记录 API 请求信息

### 6.6 CORS 配置 ✅ 已实现

#### 6.6.1 CORS 设置
- ✅ **允许的源**：配置允许的前端域名
- ✅ **允许的方法**：支持所有 HTTP 方法
- ✅ **允许的头部**：支持所有请求头
- ✅ **凭证支持**：支持携带 Cookie

#### 6.6.2 配置方式
- ✅ **环境变量配置**：从 `.env` 读取 `CORS_ORIGINS`（支持多个源，逗号分隔）
- ✅ **默认值**：未配置时使用默认值

---

## 配置与集成

### 7.1 环境变量配置 ✅ 已实现

#### 7.1.1 LLM 配置
- ✅ **新配置方式**：`LLM_PROVIDER`、`NVIDIA_API_KEY`、`NVIDIA_MODEL` 等
- ✅ **旧配置方式**：`LLM_API_KEY`、`LLM_OPENAI_BASE`、`LLM_MODEL_NAME`（兼容）
- ✅ **配置优先级**：旧配置优先

#### 7.1.2 数据库配置
- ✅ **数据库URL**：`DATABASE_URL`（默认：sqlite:///./travel_gpt.db）

#### 7.1.3 邮件配置
- ✅ **Resend**：`RESEND_API_KEY`、`FROM_EMAIL`
- ✅ **SMTP**：`SMTP_HOST`、`SMTP_PORT`、`DEFAULT_EMAIL_ACCOUNT`、`DEFAULT_EMAIL_PASSWORD`

#### 7.1.4 可选 API 配置
- ✅ **图片搜索**：`UNSPLASH_ACCESS_KEY`、`PEXELS_API_KEY`
- ✅ **天气信息**：`OPENWEATHER_API_KEY`
- ✅ **搜索工具**：`TAVILY_API_KEY`

#### 7.1.5 CORS 配置
- ✅ **CORS 源**：`CORS_ORIGINS`（已从环境变量读取，支持多个源，逗号分隔）

### 7.2 配置管理 ✅ 已实现

#### 7.2.1 Settings 类
- ✅ **Pydantic Settings**：使用 pydantic-settings 管理配置
- ✅ **环境变量读取**：自动从 `.env` 文件读取
- ✅ **默认值**：所有配置项都有合理的默认值

#### 7.2.2 配置文档
- ✅ **env.example**：完整的配置示例文件
- ✅ **配置说明**：每个配置项都有注释说明

---

## 未实现功能（待开发）

### 8.1 用户资料管理 ⚠️ 部分实现

#### 8.1.1 用户信息编辑 ⚠️ 待实现
- ⚠️ **修改邮箱**：`PUT /api/auth/me/email`
  - ⚠️ 需要验证新邮箱
  - ⚠️ 需要验证旧邮箱或密码
- ⚠️ **修改昵称**：`PUT /api/auth/me/profile`
  - ⚠️ 添加 `nickname` 字段到 User 表
- ⚠️ **上传头像**：`POST /api/auth/me/avatar`
  - ⚠️ 图片上传功能
  - ⚠️ 图片存储（本地或云存储）

#### 8.1.2 密码管理 ✅ 已实现
- ✅ **修改密码**：`PUT /api/auth/me/password`
  - ✅ 需要验证旧密码
  - ✅ 设置新密码
  - ⚠️ 前端页面：功能已实现但无独立设置页面

#### 8.1.3 账号管理 ✅ 已实现
- ✅ **账号注销**：`DELETE /api/auth/me`
  - ✅ 删除用户账号
  - ✅ 删除关联的历史记录（通过级联删除）
  - ⚠️ 前端确认操作：功能已实现但无独立设置页面

### 8.2 目的地搜索 ⚠️ 待实现

#### 8.2.1 目的地输入增强
- ⚠️ **自动补全**：目的地输入自动补全
- ⚠️ **热门目的地**：显示热门目的地推荐

### 8.3 分享功能增强 ⚠️ 部分实现

#### 8.3.1 分享方式增强
- ✅ **复制链接**：一键复制分享链接（已实现）
- ✅ **游客用户唯一URL**：游客用户自动获得唯一分享URL，避免并发冲突（已实现）
- ✅ **临时分享支持**：游客用户可通过临时分享链接分享行程（已实现）
- ⚠️ **二维码**：生成分享二维码
- ⚠️ **社交媒体**：分享到微信、微博等

### 8.4 行程编辑功能增强 ⚠️ 待实现

#### 8.4.1 部分优化
- ⚠️ **部分优化**：只优化特定天的行程（当前仅支持完整重新生成）

### 8.5 实时功能 ⚠️ 待实现

#### 8.5.1 WebSocket 支持
- ⚠️ **实时日志**：使用 WebSocket 推送规划日志
- ⚠️ **进度更新**：实时更新生成进度

#### 8.5.2 通知功能
- ⚠️ **邮件通知**：行程生成完成邮件通知
- ⚠️ **站内通知**：系统内通知功能

---

## 技术债务与改进

### 9.1 性能优化 ⚠️ 待改进

#### 9.1.1 缓存机制
- ⚠️ **API 响应缓存**：缓存常用 API 响应
- ⚠️ **图片缓存**：缓存已获取的图片 URL
- ⚠️ **搜索结果缓存**：缓存景点、餐厅搜索结果

#### 9.1.2 数据库优化
- ⚠️ **索引优化**：为常用查询字段添加索引
- ⚠️ **查询优化**：优化历史记录查询性能
- ⚠️ **分页优化**：优化大数据量分页查询

#### 9.1.3 前端优化
- ⚠️ **代码分割**：路由级别的代码分割
- ⚠️ **图片优化**：图片懒加载、WebP 格式
- ⚠️ **Bundle 优化**：减少打包体积

### 9.2 安全性改进 ⚠️ 待改进

#### 9.2.1 配置安全
- ⚠️ **SECRET_KEY**：应从环境变量读取，不应硬编码
- ⚠️ **API Key 保护**：确保 API Key 不会泄露到前端

#### 9.2.2 输入验证
- ⚠️ **更严格的验证**：更完善的输入验证规则
- ⚠️ **SQL 注入防护**：确保 SQLAlchemy 正确使用
- ⚠️ **XSS 防护**：前端 XSS 防护

#### 9.2.3 速率限制
- ⚠️ **API 速率限制**：防止 API 滥用
- ⚠️ **验证码频率限制**：防止验证码滥用

### 9.3 错误处理改进 ⚠️ 待改进

#### 9.3.1 错误边界
- ⚠️ **React 错误边界**：前端错误边界组件
- ⚠️ **全局错误处理**：统一的错误处理机制

#### 9.3.2 错误日志
- ⚠️ **错误追踪**：集成错误追踪服务（如 Sentry）
- ⚠️ **详细日志**：更详细的错误日志记录

### 9.4 文档完善 ⚠️ 待改进

#### 9.4.1 API 文档
- ⚠️ **OpenAPI 规范**：完善 FastAPI 自动生成的 API 文档
- ⚠️ **使用示例**：更多 API 使用示例

#### 9.4.2 开发文档
- ⚠️ **架构文档**：系统架构说明
- ⚠️ **开发指南**：新开发者入门指南
- ⚠️ **部署文档**：详细的部署步骤

### 9.5 功能完善 ⚠️ 待改进

#### 9.5.1 工具集成
- ⚠️ **真实 API 集成**：将模拟的景点、餐厅搜索替换为真实 API
  - ⚠️ Google Places API
  - ⚠️ Yelp API
  - ⚠️ 其他旅行相关 API

#### 9.5.2 数据丰富
- ⚠️ **更多目的地数据**：支持更多城市和目的地
- ⚠️ **实时数据**：实时价格、营业时间等

---

## 功能优先级

### P0 - 核心功能（必须实现）
1. ✅ 用户注册、登录、忘记密码
2. ✅ AI 行程生成
3. ✅ 历史记录管理
4. ✅ 游客模式支持

### P1 - 重要功能（应该实现）
1. ✅ PDF 导出
2. ✅ 分享功能（包括分享页面、临时分享、唯一URL）
3. ✅ CORS 配置从环境变量读取
4. ✅ 收藏功能
5. ✅ 行程编辑和重新生成
6. ✅ 搜索与筛选（包括前端UI）
7. ⚠️ 用户资料管理（部分实现：密码修改、账号删除已实现，邮箱/昵称/头像未实现）

### P2 - 增强功能（可以实现）
1. ✅ 收藏功能（已完成）
2. ✅ 行程编辑（已完成）
3. ✅ 搜索与筛选前端UI（已完成）
4. ✅ 游客用户唯一URL（已完成，避免并发冲突）
5. ⚠️ 分享二维码生成
6. ⚠️ 目的地自动补全
7. ⚠️ 部分行程优化（仅优化特定天）

### P3 - 高级功能（未来考虑）
1. ⚠️ 多人协作
2. ⚠️ WebSocket 实时功能
3. ⚠️ 移动端 App
4. ⚠️ 多语言支持

---

## 配置项清单

### 必需配置
- `LLM_PROVIDER` - LLM 提供商（nvidia/ollama/dashscope）
- `NVIDIA_API_KEY` - NVIDIA API 密钥（使用 nvidia 时必需）
- `RESEND_API_KEY` 或 SMTP 配置 - 邮件服务（用于注册/重置密码）

### 可选配置
- `UNSPLASH_ACCESS_KEY` - Unsplash 图片 API
- `PEXELS_API_KEY` - Pexels 图片 API
- `OPENWEATHER_API_KEY` - 天气信息 API
- `TAVILY_API_KEY` - 搜索工具 API
- `CORS_ORIGINS` - CORS 允许的源
- `DATABASE_URL` - 数据库 URL

---

## 数据流说明

### 行程生成流程
1. 用户填写表单 → 前端验证
2. 提交到 `/api/generate-plan` → 后端接收
3. AI Agent 处理 → 调用 LLM 生成行程
4. 后处理（添加图片等） → 返回完整行程
5. **登录用户** → 自动保存到数据库 → 跳转到 `/result` 或 `/result?id={id}`
6. **游客用户** → 创建临时分享链接 → 跳转到 `/result?token={token}`（唯一URL）
7. 前端展示 → 结果页面通过token或id从API获取数据展示

### 用户注册流程
1. 输入邮箱 → 发送验证码
2. 输入验证码 → 验证验证码
3. 输入密码 → 创建账号
4. 自动登录 → 跳转首页

### 密码重置流程
1. 输入邮箱 → 发送重置验证码
2. 输入验证码和新密码 → 重置密码
3. 自动登录 → 跳转首页

---

## 注意事项

1. **游客模式**：核心功能必须支持游客模式，不能强制登录
2. **并发安全**：游客用户通过唯一token URL访问行程，避免多用户在同一浏览器上的数据冲突
3. **向后兼容**：保留旧配置方式，确保现有配置继续工作；结果页面支持从localStorage读取（向后兼容）
4. **数据安全**：敏感信息（API Key、密码）不能暴露到前端
5. **错误处理**：所有 API 都应该有友好的错误提示
6. **性能考虑**：AI 生成可能需要较长时间，需要良好的加载状态
7. **临时分享过期**：游客用户的临时分享链接默认7天过期，过期后无法访问

---

**文档维护**：此文档应随项目开发持续更新，新增功能需及时补充到此文档中。
