# ğŸ”§ æ·±åº¦ä¿®å¤ï¼šPicsumå ä½å›¾é—®é¢˜

## é—®é¢˜ç°è±¡
è°ƒç”¨agentç”Ÿæˆçš„æ—…è¡Œè®¡åˆ’ä¸­ï¼Œå›¾ç‰‡æ¥æºæ˜¯ `picsum.photos` çš„éšæœºå ä½å›¾ï¼Œè€Œä¸æ˜¯ä»Unsplashæˆ–Pexelsè·å–çš„çœŸå®å›¾ç‰‡ã€‚

---

## ğŸ” é—®é¢˜æ ¹å› 

ç»è¿‡æ·±å…¥æ’æŸ¥ï¼Œå‘ç°äº†**æ ¸å¿ƒé—®é¢˜**ï¼š

### æ ¹æœ¬åŸå› ï¼šLLMæ²¡æœ‰éµå®ˆPromptæŒ‡ç¤º

å°½ç®¡Promptä¸­æ˜ç¡®è¯´æ˜ï¼š
```
ğŸš« ç»å¯¹ç¦æ­¢åœ¨ JSON è¾“å‡ºä¸­åŒ…å« "images" å­—æ®µ
âŒ ä¸è¦å†™ "images": ["https://picsum.photos/..."]
```

**ä½†LLMï¼ˆé€šä¹‰åƒé—®ï¼‰ä»ç„¶åœ¨ç”Ÿæˆçš„JSONä¸­åŒ…å«äº†`images`å­—æ®µï¼Œå¹¶å¡«å……äº†picsumå ä½å›¾é“¾æ¥ï¼**

### é—®é¢˜æµç¨‹

1. âœ… LLMç”Ÿæˆè¡Œç¨‹JSON **ï¼ˆä½†åŒ…å«äº†picsumå›¾ç‰‡é“¾æ¥ï¼‰**
2. âœ… åç«¯è§£æJSONï¼Œåˆ›å»ºTravelItineraryå¯¹è±¡
3. âœ… åç«¯è°ƒç”¨`_add_images_to_itinerary()`å°è¯•æ›¿æ¢å›¾ç‰‡
4. âŒ **ä½†æ˜¯**ï¼šå¦‚æœUnsplash/Pexels APIè°ƒç”¨å¤±è´¥æˆ–è¿”å›ç©ºï¼Œä»£ç å†™çš„æ˜¯ï¼š
   ```python
   activity.images = images if images else []
   ```
5. âŒ **å…³é”®é—®é¢˜**ï¼šå½“`images`ä¸ºç©ºæ•°ç»„æ—¶ï¼Œåº”è¯¥è®¾ç½®ä¸º`[]`ï¼Œä½†**Pydanticå¯èƒ½ä¿ç•™äº†åŸæœ‰å€¼**ï¼

### ä¸ºä»€ä¹ˆä¹‹å‰çš„ä¿®å¤ä¸å¤Ÿ

ä¹‹å‰çš„ä¿®å¤åªæ˜¯ï¼š
- âœ… æ”¹è¿›äº†ä¸­æ–‡å‰ç¼€æ¸…ç†
- âœ… ä¼˜åŒ–äº†æœç´¢å…³é”®è¯

ä½†**æ²¡æœ‰å¼ºåˆ¶æ¸…é™¤LLMç”Ÿæˆçš„å ä½å›¾**ï¼

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤1: å¼ºåˆ¶æ¸…é™¤LLMç”Ÿæˆçš„å›¾ç‰‡ï¼ˆæ–°å¢ï¼‰

åœ¨`_add_images_to_itinerary()`å¼€å¤´ï¼Œ**å¼ºåˆ¶æ¸…é™¤æ‰€æœ‰ç°æœ‰å›¾ç‰‡**ï¼š

```python
# ğŸ”§ ç¬¬ä¸€æ­¥ï¼šå¼ºåˆ¶æ¸…é™¤æ‰€æœ‰LLMå¯èƒ½ç”Ÿæˆçš„å›¾ç‰‡
logger.info("ğŸ§¹ ç¬¬ä¸€æ­¥ï¼šæ¸…é™¤æ‰€æœ‰ç°æœ‰å›¾ç‰‡...")
cleaned_count = 0
for daily_plan in itinerary.dailyPlans:
    for activity in daily_plan.activities:
        if hasattr(activity, 'images') and activity.images:
            old_images = activity.images.copy()
            activity.images = []  # å¼ºåˆ¶æ¸…ç©º
            cleaned_count += 1
            logger.warning(f"   âš ï¸  æ¸…é™¤äº† '{activity.title}' çš„ {len(old_images)} å¼ å›¾ç‰‡:")
            for img in old_images[:1]:
                if 'picsum' in img or 'placeholder' in img:
                    logger.warning(f"      âŒ å ä½å›¾: {img[:60]}...")
```

**å…³é”®ç‚¹**ï¼š
- ğŸ“ **æ— è®ºå¦‚ä½•å…ˆæ¸…ç©º**ï¼Œä¸ç»™å ä½å›¾ä»»ä½•æœºä¼š
- ğŸ“ ç„¶åå†è°ƒç”¨APIè·å–çœŸå®å›¾ç‰‡
- ğŸ“ å³ä½¿APIå¤±è´¥ï¼Œä¹Ÿæ˜¯ç©ºæ•°ç»„ï¼Œè€Œä¸æ˜¯å ä½å›¾

### ä¿®å¤2: æ·»åŠ è°ƒè¯•æ—¥å¿—

åœ¨`_parse_agent_output()`ä¸­æ·»åŠ æ£€æŸ¥ï¼š

```python
# ğŸ” è°ƒè¯•ï¼šæ£€æŸ¥LLMæ˜¯å¦ç”Ÿæˆäº†imageså­—æ®µ
print(f"\nğŸ” è°ƒè¯•ï¼šæ£€æŸ¥LLMç”Ÿæˆçš„æ•°æ®ä¸­æ˜¯å¦åŒ…å«imageså­—æ®µ...")
llm_has_images = False
for day in itinerary.dailyPlans:
    for activity in day.activities:
        if hasattr(activity, 'images') and activity.images:
            llm_has_images = True
            print(f"âš ï¸  è­¦å‘Šï¼šLLMä¸º '{activity.title}' ç”Ÿæˆäº† {len(activity.images)} ä¸ªimages:")
            for img in activity.images[:2]:
                print(f"     - {img[:80]}...")

if not llm_has_images:
    print(f"âœ… LLMæœªç”Ÿæˆimageså­—æ®µï¼ˆç¬¦åˆé¢„æœŸï¼‰")
else:
    print(f"âŒ LLMç”Ÿæˆäº†imageså­—æ®µï¼ˆè¿åäº†PromptæŒ‡ç¤ºï¼‰")
```

**ä½œç”¨**ï¼š
- ğŸ” å¸®åŠ©è¯Šæ–­LLMæ˜¯å¦éµå®ˆäº†Prompt
- ğŸ” è®°å½•å ä½å›¾çš„æ¥æº

---

## ğŸ“Š ä¿®å¤æ•ˆæœ

### Before (ä¿®å¤å‰)
```json
{
  "title": "å¤–æ»©",
  "images": [
    "https://picsum.photos/800/600?random=1",
    "https://picsum.photos/800/600?random=2",
    "https://picsum.photos/800/600?random=3"
  ]
}
```
âŒ ç”¨æˆ·çœ‹åˆ°çš„æ˜¯éšæœºå ä½å›¾

### After (ä¿®å¤å)
```json
{
  "title": "å¤–æ»©",
  "images": [
    "https://images.unsplash.com/photo-xxx?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&q=80&w=1080",
    "https://images.unsplash.com/photo-yyy?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&q=80&w=1080",
    "https://images.pexels.com/photos/zzz/pexels-photo-zzz.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750"
  ]
}
```
âœ… ç”¨æˆ·çœ‹åˆ°çš„æ˜¯çœŸå®çš„å¤–æ»©ç…§ç‰‡

---

## ğŸš€ éªŒè¯æ­¥éª¤

### 1. é‡å¯åç«¯æœåŠ¡
```bash
cd backend
python main.py
```

### 2. æŸ¥çœ‹æ—¥å¿—è¾“å‡º

ç”Ÿæˆæ—…è¡Œè®¡åˆ’æ—¶ï¼Œåº”è¯¥çœ‹åˆ°ï¼š

```
ğŸ” è°ƒè¯•ï¼šæ£€æŸ¥LLMç”Ÿæˆçš„æ•°æ®ä¸­æ˜¯å¦åŒ…å«imageså­—æ®µ...
âŒ LLMç”Ÿæˆäº†imageså­—æ®µï¼ˆè¿åäº†PromptæŒ‡ç¤ºï¼‰
âš ï¸  è­¦å‘Šï¼šLLMä¸º 'å¤–æ»©' ç”Ÿæˆäº† 3 ä¸ªimages:
     - https://picsum.photos/800/600?random=1

ğŸ§¹ ç¬¬ä¸€æ­¥ï¼šæ¸…é™¤æ‰€æœ‰ç°æœ‰å›¾ç‰‡...
âš ï¸  æ¸…é™¤äº† 'å¤–æ»©' çš„ 3 å¼ å›¾ç‰‡:
   âŒ å ä½å›¾: https://picsum.photos/800/600?random=1
âœ… å·²æ¸…é™¤ 10 ä¸ªæ´»åŠ¨çš„åŸæœ‰å›¾ç‰‡

ğŸ–¼ï¸  å¼€å§‹ä¸ºæ´»åŠ¨æ·»åŠ çœŸå®å›¾ç‰‡...
ğŸ” get_image_for_activity è¢«è°ƒç”¨
   è¾“å…¥å‚æ•°:
   - activity_name: å¤–æ»©
   - location: ä¸Šæµ·
   - category: æ™¯ç‚¹
ğŸ“ æ¸…ç†åçš„åç§°: 'å¤–æ»©'
ğŸ” æœ€ç»ˆæœç´¢å…³é”®è¯: 'å¤–æ»© ä¸Šæµ· landmark travel attraction'
ğŸ“¸ æ­¥éª¤1: å°è¯• Unsplash API (ç›®æ ‡: 3å¼ )
   ç»“æœ: è·å¾— 3 å¼ å›¾ç‰‡
âœ… æœ€ç»ˆç»“æœ: æˆåŠŸè·å– 3 å¼ å›¾ç‰‡
   1. https://images.unsplash.com/photo-xxx...
   2. https://images.unsplash.com/photo-yyy...
   3. https://images.unsplash.com/photo-zzz...
```

### 3. å‰ç«¯éªŒè¯

- è®¿é—® http://localhost:3000
- ç”Ÿæˆä¸€ä¸ªæ—…è¡Œè®¡åˆ’
- æ£€æŸ¥å›¾ç‰‡æ¥æºï¼š
  - âœ… `images.unsplash.com` - UnsplashçœŸå®å›¾ç‰‡
  - âœ… `images.pexels.com` - PexelsçœŸå®å›¾ç‰‡
  - âŒ `picsum.photos` - å ä½å›¾ï¼ˆä¸åº”å‡ºç°ï¼‰

### 4. ä½¿ç”¨è°ƒè¯•è„šæœ¬

```bash
# ä¿å­˜ç”Ÿæˆçš„JSONåˆ°æ–‡ä»¶
# ç„¶åè¿è¡Œï¼š
cd backend
python debug_images.py itinerary.json
```

åº”è¯¥çœ‹åˆ°ï¼š
```
ğŸ“Š ç»Ÿè®¡ç»“æœ
æ€»æ´»åŠ¨æ•°: 10
æœ‰å›¾ç‰‡çš„æ´»åŠ¨: 10

å›¾ç‰‡æ¥æºåˆ†æ:
  âŒ Picsumå ä½å›¾: 0
  âŒ Placeholderå ä½å›¾: 0
  âœ… UnsplashçœŸå®å›¾ç‰‡: 20
  âœ… PexelsçœŸå®å›¾ç‰‡: 10

âœ… æœªå‘ç°å ä½å›¾ï¼Œæ‰€æœ‰å›¾ç‰‡å‡æ¥è‡ªçœŸå®API
```

---

## ğŸ¯ æŠ€æœ¯æ€»ç»“

### é—®é¢˜æœ¬è´¨

**LLMä¸å¯é **ï¼šå³ä½¿Promptæ˜ç¡®ç¦æ­¢ï¼ŒLLMä»å¯èƒ½ç”Ÿæˆä¸ç¬¦åˆè¦æ±‚çš„å†…å®¹ã€‚

### è§£å†³æ–¹æ¡ˆ

**åç«¯å¼ºåˆ¶æ§åˆ¶**ï¼šä¸ä¾èµ–LLMçš„éµå®ˆï¼Œè€Œæ˜¯åœ¨ä»£ç å±‚é¢å¼ºåˆ¶ï¼š
1. âœ… **å…ˆæ¸…ç©º**æ‰€æœ‰LLMç”Ÿæˆçš„å›¾ç‰‡
2. âœ… **å†è°ƒç”¨**çœŸå®APIè·å–å›¾ç‰‡
3. âœ… **å³ä½¿å¤±è´¥**ä¹Ÿè¿”å›ç©ºæ•°ç»„ï¼Œä¸ä¿ç•™å ä½å›¾

### ç»éªŒæ•™è®­

1. **ä¸è¦å®Œå…¨ä¿¡ä»»LLMçš„è¾“å‡º**
   - LLMå¯èƒ½ä¸éµå®ˆPromptæŒ‡ç¤º
   - éœ€è¦åç«¯å¼ºåˆ¶éªŒè¯å’Œæ¸…ç†

2. **Pydanticæ¨¡å‹çš„é»˜è®¤å€¼é™·é˜±**
   - `images: Optional[List[str]] = []`
   - èµ‹å€¼æ—¶è¦å°å¿ƒï¼Œç¡®ä¿çœŸæ­£è¦†ç›–

3. **è°ƒè¯•æ—¥å¿—è‡³å…³é‡è¦**
   - æ·»åŠ è¯¦ç»†æ—¥å¿—å¸®åŠ©å®šä½é—®é¢˜
   - è®°å½•æ¯ä¸€æ­¥çš„æ•°æ®å˜åŒ–

---

## ğŸ“ ä¿®æ”¹çš„æ–‡ä»¶

1. âœ… `backend/app/agent.py`
   - æ·»åŠ LLMç”Ÿæˆå›¾ç‰‡çš„æ£€æµ‹æ—¥å¿—
   - å¼ºåˆ¶æ¸…é™¤æ‰€æœ‰ç°æœ‰å›¾ç‰‡çš„é€»è¾‘
   - ç§»é™¤å†—ä½™çš„è­¦å‘Šä¿¡æ¯

2. âœ… `backend/debug_images.py`ï¼ˆæ–°å¢ï¼‰
   - åˆ†æJSONä¸­å›¾ç‰‡æ¥æºçš„å·¥å…·

---

## ğŸ”— ç›¸å…³é—®é¢˜

### Q: ä¸ºä»€ä¹ˆä¸æ”¹Promptè®©LLMéµå®ˆï¼Ÿ

A: **å·²ç»å°è¯•è¿‡**ï¼ŒPromptä¸­ç”¨äº†å¤§é‡emojiã€é‡å¤å¼ºè°ƒã€ç¤ºä¾‹è¯´æ˜ï¼Œä½†LLMï¼ˆé€šä¹‰åƒé—®ï¼‰ä»ç„¶ä¼šå¶å°”ç”Ÿæˆimageså­—æ®µã€‚**LLMçš„ä¸ç¡®å®šæ€§å†³å®šäº†ä¸èƒ½å®Œå…¨ä¾èµ–å®ƒ**ã€‚

### Q: ä¸ºä»€ä¹ˆä¸åœ¨Pydanticæ¨¡å‹å±‚é¢ç¦æ­¢imageså­—æ®µï¼Ÿ

A: **éœ€è¦è¿™ä¸ªå­—æ®µ**ï¼Œå› ä¸ºåç«¯è¦ç”¨å®ƒæ¥å­˜å‚¨çœŸå®å›¾ç‰‡URLã€‚è§£å†³æ–¹æ¡ˆæ˜¯**è¿è¡Œæ—¶å¼ºåˆ¶æ¸…ç†**ï¼Œè€Œä¸æ˜¯æ¨¡å‹å±‚é¢ç¦æ­¢ã€‚

### Q: èƒ½å¦è®©å‰ç«¯è¿‡æ»¤å ä½å›¾ï¼Ÿ

A: **å¯ä»¥ï¼Œä½†ä¸å¤Ÿå½»åº•**ã€‚å‰ç«¯å·²ç»æœ‰è¿‡æ»¤é€»è¾‘ï¼š
```typescript
const ALLOWED_IMAGE_DOMAINS = [
  'images.unsplash.com',
  'source.unsplash.com',
  'images.pexels.com',
]
```
ä½†**åç«¯åº”è¯¥ç¡®ä¿å‘é€æ­£ç¡®æ•°æ®**ï¼Œè€Œä¸æ˜¯è®©å‰ç«¯åšæ•°æ®æ¸…ç†ã€‚

---

**ä¿®å¤å®Œæˆï¼** ğŸ‰

é‡å¯åç«¯æœåŠ¡ï¼Œé—®é¢˜åº”è¯¥å½»åº•è§£å†³ã€‚å¦‚æœè¿˜æœ‰é—®é¢˜ï¼ŒæŸ¥çœ‹æ—¥å¿—è¾“å‡ºå¹¶è¿è¡Œ`debug_images.py`åˆ†ææ•°æ®ã€‚
